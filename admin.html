<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL - STAR TRACKER</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Editable cell styling */
        .editable-cell {
            transition: background-color 0.2s, outline 0.2s;
        }
        
        .editable-cell:hover {
            background-color: rgba(208, 82, 82, 0.1) !important;
            outline: 1px solid rgba(208, 82, 82, 0.3);
        }
        
        .editable-cell:focus {
            background-color: rgba(208, 82, 82, 0.15) !important;
            outline: 2px solid #d05252;
            outline-offset: -2px;
        }
        
        /* Empty cell placeholder */
        .editable-cell:empty:before {
            content: 'NULL';
            color: rgba(171, 169, 162, 0.4);
            font-style: italic;
        }
        
        .editable-cell:focus:empty:before {
            content: '';
        }
        
        /* New row styling */
        #newRow {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Delete button hover effect */
        .delete-row-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(208, 82, 82, 0.5);
        }
        
        /* Button hover effects */
        #insertRowBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(82, 208, 117, 0.4);
        }
        
        #saveChangesBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(208, 82, 82, 0.4);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-logo">
                <span class="logo-text">ADMIN PANEL</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="logo-text" id="adminUsername" style="font-size: 11px;">ADMIN</span>
                <button class="btn btn-icon" id="darkModeToggle" title="Toggle Dark Mode">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="btn btn-icon" onclick="logout()" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="main-stats" style="border-bottom: none;">
                <div class="stat-box" id="totalUsers">
                    <div class="stat-label">TOTAL USERS</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="verifiedUsers">
                    <div class="stat-label">VERIFIED</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="totalKills">
                    <div class="stat-label">TOTAL KILLS</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="adminLogins">
                    <div class="stat-label">ADMIN LOGINS</div>
                    <div class="stat-value">-</div>
                </div>
            </div>
        </div>

        <!-- View Buttons -->
        <div class="view-buttons" style="margin-bottom: 0; border-bottom: none;">
            <button class="view-btn active" onclick="switchTab('users', event)">USERS</button>
            <button class="view-btn" onclick="switchTab('audit', event)">AUDIT LOGS</button>
            <button class="view-btn" onclick="switchTab('tools', event)">TOOLS</button>
        </div>
        <div class="view-buttons" style="grid-template-columns: 1fr;">
            <button class="view-btn" onclick="switchTab('sql', event)">SQL QUERY</button>
        </div>

        <!-- Users Tab -->
        <div id="usersTab">
            <!-- Search and Filter Panel -->
            <div class="filter-panel">
                <div class="filter-row">
                    <div class="search-container">
                        <input type="text" id="userSearch" class="search-input" placeholder="SEARCH USERNAME OR IN-GAME NAME..." oninput="filterUsers()">
                    </div>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="custom-select" id="verificationFilter">
                        <div class="select-display">ALL USERS</div>
                        <div class="select-options">
                            <div class="select-option" data-value="all">ALL USERS</div>
                            <div class="select-option" data-value="verified">VERIFIED ONLY</div>
                            <div class="select-option" data-value="unverified">UNVERIFIED ONLY</div>
                        </div>
                    </div>
                    <div class="custom-select" id="sortFilter">
                        <div class="select-display">SORT OPTIONS</div>
                        <div class="select-options">
                            <div class="select-option" data-value="newest">NEWEST FIRST</div>
                            <div class="select-option" data-value="oldest">OLDEST FIRST</div>
                            <div class="select-option" data-value="kills-high">MOST KILLS</div>
                            <div class="select-option" data-value="kills-low">LEAST KILLS</div>
                            <div class="select-option" data-value="username">USERNAME A-Z</div>
                        </div>
                    </div>
                    <button class="reset-filter-btn" onclick="resetFilters()" style="width: 100%;">RESET FILTERS</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area" id="usersContent">
                <div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">LOADING USERS...</div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="auditTab" style="display: none;">
            <div class="content-area" id="auditContent" style="min-height: 400px;">
                <div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">LOADING AUDIT LOGS...</div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div id="toolsTab" style="display: none;">
            <div class="filter-panel">
                <div class="filter-row">
                    <div id="toolsMessage" style="padding: 25px 40px; font-size: 11px; letter-spacing: 2px; text-transform: uppercase;">KILL REASSIGNMENT</div>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
                    <input type="text" id="sourceUserId" class="search-input" placeholder="SOURCE USER ID" style="border-right: 2px solid #18140c;">
                    <input type="text" id="targetUserId" class="search-input" placeholder="TARGET USER ID">
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr;">
                    <button class="view-btn" onclick="reassignKills()" style="width: 100%;">REASSIGN KILLS</button>
                </div>
            </div>
            
            <div class="content-area" style="min-height: 200px; display: grid; grid-template-columns: 1fr 1fr;">
                <button class="view-btn" onclick="clearUserDatabase()" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;">CLEAR USER DATABASE</button>
                <button class="view-btn" onclick="clearKillsDatabase()" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border: none;">CLEAR KILLS DATABASE</button>
            </div>
        </div>

        <!-- SQL Query Tab -->
        <div id="sqlTab" style="display: none;">
            <div class="filter-panel">
                <div class="filter-row">
                    <div style="padding: 25px 40px; font-size: 11px; letter-spacing: 2px; text-transform: uppercase;">DIRECT SQL QUERY EXECUTOR</div>
                </div>
                <div class="filter-row" style="grid-template-columns: repeat(5, 1fr); gap: 2px;">
                    <button class="view-btn" onclick="setQuery('SELECT * FROM Users ORDER BY CreatedAt DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">SHOW ALL USERS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM Kills ORDER BY KillTime DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">SHOW ALL KILLS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM Admins ORDER BY CreatedAt DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">SHOW ADMINS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM UserTokens ORDER BY CreatedAt DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">USER TOKENS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM app_versions ORDER BY RELEASE_DATE DESC')" style="border-radius: 0; border: none;">APP VERSIONS</button>
                </div>
                <div class="filter-row" style="grid-template-columns: repeat(5, 1fr); gap: 2px;">
                    <button class="view-btn" onclick="setQuery('SELECT * FROM Kills WHERE IsPlayer=1 ORDER BY KillTime DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">ALL PLAYER KILLS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM Kills WHERE IsPlayer=0 ORDER BY KillTime DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">ALL NPC KILLS</button>
                    <button class="view-btn" onclick="setQuery('SELECT * FROM AdminAuditLog ORDER BY Timestamp DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">AUDIT LOGS</button>
                    <button class="view-btn" onclick="setQuery('SELECT TOP 10 KillerUser, VictimUser, COUNT(*) as Encounters FROM Kills WHERE IsPlayer=1 GROUP BY KillerUser, VictimUser ORDER BY Encounters DESC')" style="border-radius: 0; border-right: 2px solid #18140c;">ENCOUNTERS</button>
                    <button class="view-btn" onclick="setQuery('SELECT Weapon, COUNT(*) as Count FROM Kills GROUP BY Weapon ORDER BY Count DESC')" style="border-radius: 0; border: none;">WEAPON STATS</button>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr;">
                    <textarea id="sqlQuery" class="search-input" placeholder="ENTER SQL QUERY..." style="min-height: 150px; font-family: 'Courier New', monospace; resize: vertical; padding: 15px;"></textarea>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
                    <button class="view-btn" onclick="executeSqlQuery()" style="background: #d05252; border-color: #d05252; color: #aba9a2;">EXECUTE QUERY</button>
                    <button class="view-btn" onclick="clearSqlQuery()">CLEAR</button>
                </div>
            </div>
            
            <div class="content-area" id="sqlResults" style="min-height: 300px; padding: 40px;">
                <div style="font-size: 11px; letter-spacing: 2px; text-transform: uppercase; opacity: 0.6;">QUERY RESULTS WILL APPEAR HERE</div>
            </div>
        </div>
    </div>

    <script src="config/api.js"></script>
    <script>
        let allUsers = [];
        let filteredUsers = [];
        let expandedUserId = null;
        let redirecting = false;

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('adminToken');
            
            if (!token) {
                if (!redirecting) {
                    redirecting = true;
                    localStorage.removeItem('adminToken');
                    window.location.replace('admin-login.html');
                }
                return null;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });

                if (response.status === 401) {
                    if (!redirecting) {
                        redirecting = true;
                        localStorage.removeItem('adminToken');
                        window.location.replace('admin-login.html');
                    }
                    return null;
                }

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `Request failed with status ${response.status}`);
                }

                // For DELETE requests that might not return JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                }
                
                // Return success object for non-JSON responses
                return { success: true };
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const stats = await apiCall('/api/Admin/stats');
                if (stats) {
                    document.querySelector('#totalUsers .stat-value').textContent = stats.totalUsers || 0;
                    document.querySelector('#verifiedUsers .stat-value').textContent = stats.verifiedUsers || 0;
                    document.querySelector('#totalKills .stat-value').textContent = stats.totalKills || 0;
                    document.querySelector('#adminLogins .stat-value').textContent = stats.adminLogins || 0;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const result = await apiCall('/api/Admin/users');
                if (result) {
                    console.log('Loaded users:', result);
                    console.log('First user:', result[0]);
                    allUsers = result;
                    filteredUsers = [...allUsers];
                    renderUsers();
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersContent').innerHTML = '<div class="error" style="text-align: center; padding: 40px;">FAILED TO LOAD USERS</div>';
            }
        }

        function renderUsers() {
            if (filteredUsers.length === 0) {
                document.getElementById('usersContent').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">NO USERS FOUND</div>';
                return;
            }

            const usersHtml = filteredUsers.map(user => `
                <div class="user-item" id="user-${user.id}" style="border-bottom: 2px solid #18140c;">
                    <div class="kill-entry" onclick="toggleUserDetails(${user.id})" style="cursor: pointer; border-bottom: none;">
                        <div class="kill-players">
                            <span class="player-name" style="font-weight: 500;">${user.username || 'Unknown'}</span>
                            <span class="meta-item" style="margin-left: 20px;">ID: ${user.id}</span>
                            ${user.isPublicProfile ? '<span class="meta-item" style="color: #52d075;">✓ VERIFIED</span>' : '<span class="meta-item" style="color: #d05252;">✗ NOT VERIFIED</span>'}
                        </div>
                        <div class="kill-meta">
                            <span class="meta-item">${user.totalKills || 0} KILLS</span>
                            <span class="meta-item">${user.inGameName || 'NO IN-GAME NAME'}</span>
                            <span class="kill-time">${new Date(user.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="user-details" id="details-${user.id}" style="display: none; border: 2px solid #18140c; margin: 40px;">
                        <div style="padding: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">USER ID</div>
                                <div style="font-size: 14px;">${user.id}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">USERNAME</div>
                                <div style="font-size: 14px;">${user.username || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">IN-GAME NAME</div>
                                <div style="font-size: 14px;">${user.inGameName || 'NO IN-GAME NAME'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">EMAIL</div>
                                <div style="font-size: 14px;">${user.email || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">VERIFIED</div>
                                <div style="font-size: 14px;">${user.isPublicProfile ? 'YES' : 'NO'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">TOTAL KILLS</div>
                                <div style="font-size: 14px;">${user.totalKills || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">CREATED</div>
                                <div style="font-size: 14px;">${new Date(user.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">LAST LOGIN</div>
                                <div style="font-size: 14px;">${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString() : 'Never'}</div>
                            </div>
                        </div>
                        <div style="padding: 40px; padding-top: 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; border: 2px solid #18140c;">
                                <button class="view-btn" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;" onclick="deleteUser(${user.id})">DELETE USER</button>
                                <button class="view-btn" style="border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;" onclick="viewUserProfile('${user.username}')">PROFILE</button>
                                <button class="view-btn" style="border-radius: 0; border: none;" onclick="toggleVerification(${user.id})">${user.isPublicProfile ? 'UNVERIFY' : 'VERIFY'} USER</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('usersContent').innerHTML = usersHtml;
        }

        function toggleUserDetails(userId) {
            const detailsElement = document.getElementById(`details-${userId}`);
            
            if (expandedUserId === userId) {
                detailsElement.style.display = 'none';
                expandedUserId = null;
            } else {
                if (expandedUserId !== null) {
                    const previousDetails = document.getElementById(`details-${expandedUserId}`);
                    if (previousDetails) {
                        previousDetails.style.display = 'none';
                    }
                }
                detailsElement.style.display = 'block';
                expandedUserId = userId;
            }
        }

        async function deleteUser(userId) {
            console.log('deleteUser called with userId:', userId, 'type:', typeof userId);
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    const endpoint = `/api/Admin/users/${userId}`;
                    console.log('Calling DELETE:', endpoint);
                    await apiCall(endpoint, { method: 'DELETE' });
                    alert('User deleted successfully');
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete user: ' + JSON.stringify(error.message || error));
                }
            }
        }

        function viewUserProfile(username) {
            // Open the user's profile page in a new tab
            window.open(`/profile.html?user=${encodeURIComponent(username)}`, '_blank');
        }

        async function resetPassword(userId) {
            if (confirm('Send password reset email to this user?')) {
                try {
                    await apiCall(`/api/Admin/users/${userId}/reset-password`, { method: 'POST' });
                    alert('Password reset email sent successfully');
                } catch (error) {
                    alert('Failed to send password reset: ' + error.message);
                }
            }
        }

        async function toggleVerification(userId) {
            const user = allUsers.find(u => u.id === userId);
            const action = user.isPublicProfile ? 'unverify' : 'verify';
            
            if (confirm(`${action.toUpperCase()} this user?`)) {
                try {
                    await apiCall(`/api/Admin/users/${userId}/verification`, {
                        method: 'PUT',
                        body: JSON.stringify({ isPublicProfile: !user.isPublicProfile })
                    });
                    alert(`User ${action}ed successfully`);
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    alert(`Failed to ${action} user: ` + error.message);
                }
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const verificationFilterValue = document.querySelector('#verificationFilter .select-display').getAttribute('data-value') || 'all';
            const sortFilter = document.querySelector('#sortFilter .select-display').getAttribute('data-value') || 'newest';

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = searchTerm === '' || 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) || 
                    (user.inGameName && user.inGameName.toLowerCase().includes(searchTerm));
                
                const matchesVerification = 
                    verificationFilterValue === 'all' ||
                    (verificationFilterValue === 'verified' && user.isPublicProfile) ||
                    (verificationFilterValue === 'unverified' && !user.isPublicProfile);

                return matchesSearch && matchesVerification;
            });

            // Sort users
            switch(sortFilter) {
                case 'oldest':
                    filteredUsers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'kills-high':
                    filteredUsers.sort((a, b) => (b.totalKills || 0) - (a.totalKills || 0));
                    break;
                case 'kills-low':
                    filteredUsers.sort((a, b) => (a.totalKills || 0) - (b.totalKills || 0));
                    break;
                case 'username':
                    filteredUsers.sort((a, b) => (a.username || '').localeCompare(b.username || ''));
                    break;
                case 'newest':
                default:
                    filteredUsers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
            }

            renderUsers();
        }

        // Custom select dropdown functionality
        document.addEventListener('click', (e) => {
            const select = e.target.closest('.custom-select');
            if (select) {
                e.stopPropagation();
                document.querySelectorAll('.custom-select').forEach(s => {
                    if (s !== select) s.classList.remove('open');
                });
                select.classList.toggle('open');
            } else {
                document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
            }
        });

        document.querySelectorAll('.custom-select').forEach(select => {
            const display = select.querySelector('.select-display');
            const options = select.querySelectorAll('.select-option');
            
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    display.textContent = option.textContent;
                    display.setAttribute('data-value', option.getAttribute('data-value'));
                    select.classList.remove('open');
                    filterUsers();
                });
            });
        });

        function resetFilters() {
            document.getElementById('userSearch').value = '';
            document.querySelector('#verificationFilter .select-display').textContent = 'ALL USERS';
            document.querySelector('#verificationFilter .select-display').setAttribute('data-value', 'all');
            document.querySelector('#sortFilter .select-display').textContent = 'SORT OPTIONS';
            document.querySelector('#sortFilter .select-display').removeAttribute('data-value');
            filterUsers();
        }

        function switchTab(tabName, event) {
            document.getElementById('usersTab').style.display = 'none';
            document.getElementById('auditTab').style.display = 'none';
            document.getElementById('toolsTab').style.display = 'none';
            document.getElementById('sqlTab').style.display = 'none';

            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`${tabName}Tab`).style.display = 'block';
            event.target.classList.add('active');

            if (tabName === 'audit' && document.getElementById('auditContent').innerHTML.includes('LOADING')) {
                loadAuditLogs();
            }
        }

        async function executeSqlQuery() {
            const query = document.getElementById('sqlQuery').value.trim();
            const resultsDiv = document.getElementById('sqlResults');
            
            if (!query) {
                resultsDiv.innerHTML = '<div style="color: #d05252; font-size: 11px; letter-spacing: 2px;">ERROR: QUERY CANNOT BE EMPTY</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div style="font-size: 11px; letter-spacing: 2px; text-transform: uppercase;">EXECUTING QUERY...</div>';
            
            try {
                const result = await apiCall('/api/Admin/execute-sql', {
                    method: 'POST',
                    body: JSON.stringify({ query: query })
                });
                
                if (result && result.data) {
                    // Display results as table
                    if (result.data.length === 0) {
                        resultsDiv.innerHTML = `<div style="color: #d05252; font-size: 11px; letter-spacing: 2px;">SUCCESS: QUERY EXECUTED. ${result.rowsAffected || 0} ROWS AFFECTED.</div>`;
                    } else {
                        // Detect table name from query
                        const queryLower = query.toLowerCase();
                        let tableName = null;
                        const tableMatch = queryLower.match(/from\s+(\w+)/);
                        if (tableMatch) {
                            tableName = tableMatch[1].charAt(0).toUpperCase() + tableMatch[1].slice(1);
                        }

                        let html = `<div style="color: #d05252; font-size: 11px; letter-spacing: 2px; margin-bottom: 10px;">SUCCESS: ${result.data.length} ROWS RETURNED</div>`;
                        
                        // Add buttons if we have a table name
                        if (tableName) {
                            html += `<div style="display: flex; gap: 10px; margin-bottom: 10px;">`;
                            html += `<button id="insertRowBtn" style="background: #52d075; color: #18140c; border: 2px solid #52d075; padding: 8px 20px; font-size: 11px; letter-spacing: 2px; font-weight: 300; text-transform: uppercase; cursor: pointer; transition: all 0.2s;" onclick="insertNewRow('${tableName}')">+ INSERT NEW ROW</button>`;
                            html += `<button id="saveChangesBtn" style="background: #d05252; color: #18140c; border: 2px solid #d05252; padding: 8px 20px; font-size: 11px; letter-spacing: 2px; font-weight: 300; text-transform: uppercase; cursor: pointer; display: none; transition: all 0.2s;" onclick="saveTableChanges('${tableName}')">SAVE CHANGES</button>`;
                            html += `</div>`;
                        }
                        
                        html += '<div style="overflow-x: auto;"><table id="sqlResultsTable" style="width: 100%; border-collapse: collapse; font-size: 11px; border: 2px solid;">';
                        
                        // Calculate optimal width for each column based on content type
                        const keys = Object.keys(result.data[0]);
                        const columnWidths = {};
                        keys.forEach((key, index) => {
                            let maxLength = key.length;
                            let columnType = 'string'; // default
                            
                            // Detect column type from first non-null value
                            for (let row of result.data) {
                                const value = row[key];
                                if (value !== null) {
                                    const strValue = String(value);
                                    
                                    // Check for ID (column name or numeric value)
                                    if (key.toLowerCase().includes('id') || key.toLowerCase() === 'id') {
                                        columnType = 'id';
                                    }
                                    // Check for boolean
                                    else if (typeof value === 'boolean' || strValue.toLowerCase() === 'true' || strValue.toLowerCase() === 'false') {
                                        columnType = 'bool';
                                    }
                                    // Check for date/time - stricter detection
                                    else if ((key.toLowerCase().endsWith('at') || key.toLowerCase().endsWith('date') || 
                                             key.toLowerCase().includes('created') || key.toLowerCase().includes('updated') ||
                                             key.toLowerCase().includes('timestamp')) && 
                                             (/^\d{4}-\d{2}-\d{2}/.test(strValue) || /^\d{1,2}\/\d{1,2}\/\d{4}/.test(strValue))) {
                                        columnType = 'date';
                                    }
                                    // Check for hash (long hex strings or base64)
                                    else if ((strValue.length > 40 && /^[a-fA-F0-9]+$/.test(strValue)) || 
                                             (strValue.length > 40 && /^[A-Za-z0-9+/=]+$/.test(strValue)) ||
                                             key.toLowerCase().includes('hash') || key.toLowerCase().includes('password')) {
                                        columnType = 'hash';
                                    }
                                    // Check for numeric
                                    else if (!isNaN(value) && typeof value === 'number') {
                                        columnType = 'number';
                                    }
                                    
                                    maxLength = Math.max(maxLength, strValue.length);
                                    break;
                                }
                            }
                            
                            // Set width based on type
                            let width;
                            switch(columnType) {
                                case 'id':
                                    width = Math.min(Math.max(maxLength * 6, 60), 100);
                                    break;
                                case 'bool':
                                    width = 70;
                                    break;
                                case 'date':
                                    width = 90; // Smaller fixed width for dates
                                    break;
                                case 'hash':
                                    width = 120;
                                    break;
                                case 'number':
                                    width = Math.min(Math.max(maxLength * 7, 70), 120);
                                    break;
                                default: // string
                                    width = Math.min(Math.max(maxLength * 7, 100), 300);
                            }
                            
                            columnWidths[index] = width;
                        });
                        
                        // Store column widths globally for toggle function
                        window.originalColumnWidths = columnWidths;
                        
                        // Headers with resizable columns - add delete column header
                        html += '<thead><tr style="display: flex; border-bottom: 2px solid;">';
                        
                        // Delete column header
                        if (tableName) {
                            html += `<th style="padding: 10px 5px; background: transparent; border: none; border-right: 2px solid; font-size: 10px; font-weight: 300; letter-spacing: 1px; text-align: center; text-transform: uppercase; flex: 0 0 60px;">DELETE</th>`;
                        }
                        
                        keys.forEach((key, index) => {
                            const width = columnWidths[index];
                            html += `<th data-col="${index}" class="col-header" style="position: relative; padding: 10px 5px; background: transparent; border: none; border-right: 2px solid; font-size: 10px; font-weight: 300; letter-spacing: 1px; text-align: left; text-transform: uppercase; cursor: pointer; user-select: none; transition: all 0.2s; flex: 0 0 ${width}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" onclick="toggleColumn(${index})" title="Click to expand/collapse">
                                ${key}
                                <div class="resize-handle" data-col="${index}" style="position: absolute; right: 0; top: 0; bottom: 0; width: 2px; cursor: col-resize; background: currentColor; opacity: 0.3; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.3'" onclick="event.stopPropagation()"></div>
                            </th>`;
                        });
                        html += '</tr></thead><tbody>';
                        
                        // Store original data and table info globally
                        window.sqlTableData = { tableName, keys, data: JSON.parse(JSON.stringify(result.data)) };
                        window.deletedRows = new Set();
                        window.modifiedCells = new Map();
                        
                        // Rows
                        result.data.forEach((row, rowIndex) => {
                            html += `<tr style="display: flex;" data-row="${rowIndex}">`;
                            
                            // Delete button
                            if (tableName) {
                                html += `<td style="padding: 8px 5px; border-bottom: 1px solid; border-right: 2px solid; flex: 0 0 60px; text-align: center;">
                                    <button class="delete-row-btn" onclick="markRowForDeletion(${rowIndex})" style="background: #d05252; color: #18140c; border: none; padding: 4px 8px; font-size: 9px; letter-spacing: 1px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;">DEL</button>
                                </td>`;
                            }
                            
                            keys.forEach((key, index) => {
                                const cellValue = row[key] !== null ? String(row[key]) : 'NULL';
                                const width = columnWidths[index];
                                const isPrimaryKey = key.toLowerCase() === 'id';
                                const editableAttr = tableName && !isPrimaryKey ? 'contenteditable="true"' : '';
                                const editableClass = tableName && !isPrimaryKey ? 'editable-cell' : '';
                                html += `<td data-col="${index}" data-row="${rowIndex}" data-key="${key}" class="sql-cell ${editableClass}" ${editableAttr} style="padding: 8px 5px; border-bottom: 1px solid; border-right: 2px solid; opacity: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 0 0 ${width}px; font-size: 10px; ${editableAttr ? 'cursor: text;' : ''}" ${editableAttr ? `oninput="trackCellChange(${rowIndex}, '${key}', this.textContent)"` : ''}>${cellValue}</td>`;
                            });
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table></div>';
                        resultsDiv.innerHTML = html;
                        
                        // Track expanded columns
                        window.expandedColumns = window.expandedColumns || new Set();
                        
                        // Calculate max content width for each column
                        window.columnMaxWidths = {};
                        keys.forEach((key, index) => {
                            let maxWidth = key.length * 8; // Header width
                            result.data.forEach(row => {
                                const value = row[key] !== null ? String(row[key]) : 'NULL';
                                maxWidth = Math.max(maxWidth, value.length * 8);
                            });
                            window.columnMaxWidths[index] = Math.min(Math.max(maxWidth, 150), 600);
                        });
                        
                        // Add resize functionality
                        const resizeHandles = document.querySelectorAll('.resize-handle');
                        resizeHandles.forEach(handle => {
                            let startX, startWidth, th;
                            
                            handle.addEventListener('mousedown', (e) => {
                                e.stopPropagation();
                                th = e.target.parentElement;
                                startX = e.pageX;
                                startWidth = parseInt(th.style.flex.split(' ')[2].replace('px', ''));
                                
                                const onMouseMove = (e) => {
                                    const width = startWidth + (e.pageX - startX);
                                    if (width >= 100 && width <= 800) {
                                        th.style.flex = `0 0 ${width}px`;
                                        // Update all cells in this column
                                        const colIndex = th.getAttribute('data-col');
                                        document.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(cell => {
                                            cell.style.flex = `0 0 ${width}px`;
                                        });
                                    }
                                };
                                
                                const onMouseUp = () => {
                                    document.removeEventListener('mousemove', onMouseMove);
                                    document.removeEventListener('mouseup', onMouseUp);
                                };
                                
                                document.addEventListener('mousemove', onMouseMove);
                                document.addEventListener('mouseup', onMouseUp);
                            });
                        });
                        
                        // Add hover effect to headers
                        document.querySelectorAll('.col-header').forEach(header => {
                            header.addEventListener('mouseenter', function() {
                                if (!this.classList.contains('expanded')) {
                                    this.style.background = document.body.classList.contains('dark-mode') ? '#aba9a2' : '#18140c';
                                    this.style.color = document.body.classList.contains('dark-mode') ? '#18140c' : '#aba9a2';
                                }
                            });
                            header.addEventListener('mouseleave', function() {
                                if (!this.classList.contains('expanded')) {
                                    this.style.background = 'transparent';
                                    this.style.color = '';
                                }
                            });
                        });
                    }
                } else {
                    resultsDiv.innerHTML = `<div style="color: #d05252; font-size: 11px; letter-spacing: 2px;">SUCCESS: QUERY EXECUTED. ${result.message || ''}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #d05252; font-size: 11px; letter-spacing: 2px;">ERROR: ${error.message || 'QUERY FAILED'}</div>`;
            }
        }
        
        function clearSqlQuery() {
            document.getElementById('sqlQuery').value = '';
            document.getElementById('sqlResults').innerHTML = '<div style="font-size: 11px; letter-spacing: 2px; text-transform: uppercase; opacity: 0.6;">QUERY RESULTS WILL APPEAR HERE</div>';
        }

        function setQuery(query) {
            document.getElementById('sqlQuery').value = query;
        }

        // Track cell changes
        function trackCellChange(rowIndex, key, newValue) {
            const cellKey = `${rowIndex}-${key}`;
            window.modifiedCells.set(cellKey, newValue);
            
            // Show save button
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
        }

        // Mark row for deletion
        function markRowForDeletion(rowIndex) {
            const row = document.querySelector(`tr[data-row="${rowIndex}"]`);
            if (window.deletedRows.has(rowIndex)) {
                // Unmark
                window.deletedRows.delete(rowIndex);
                row.style.opacity = '1';
                row.style.textDecoration = 'none';
                row.querySelector('.delete-row-btn').textContent = 'DEL';
                row.querySelector('.delete-row-btn').style.background = '#d05252';
            } else {
                // Mark for deletion
                window.deletedRows.add(rowIndex);
                row.style.opacity = '0.4';
                row.style.textDecoration = 'line-through';
                row.querySelector('.delete-row-btn').textContent = 'UNDO';
                row.querySelector('.delete-row-btn').style.background = '#52d075';
            }
            
            // Show save button if there are changes
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn && (window.deletedRows.size > 0 || window.modifiedCells.size > 0)) {
                saveBtn.style.display = 'inline-block';
            } else if (saveBtn && window.deletedRows.size === 0 && window.modifiedCells.size === 0) {
                saveBtn.style.display = 'none';
            }
        }

        // Save all changes
        async function saveTableChanges(tableName) {
            const saveBtn = document.getElementById('saveChangesBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'SAVING...';
            saveBtn.disabled = true;

            try {
                let queriesExecuted = 0;

                // Process new row insertion
                if (window.newRowIndex === -1 && window.newRowData) {
                    const columns = [];
                    const values = [];
                    
                    Object.entries(window.newRowData).forEach(([key, value]) => {
                        if (value !== '') {
                            columns.push(key);
                            
                            // Handle different value types
                            if (value.toLowerCase() === 'null') {
                                values.push('NULL');
                            } else if (!isNaN(value) && value !== '') {
                                values.push(value);
                            } else {
                                // String value - escape single quotes
                                const escapedValue = value.replace(/'/g, "''");
                                values.push(`'${escapedValue}'`);
                            }
                        }
                    });
                    
                    if (columns.length > 0) {
                        const insertQuery = `INSERT INTO ${tableName} (${columns.join(', ')}) VALUES (${values.join(', ')})`;
                        await apiCall('/api/Admin/execute-sql', {
                            method: 'POST',
                            body: JSON.stringify({ query: insertQuery })
                        });
                        queriesExecuted++;
                        
                        // Clear new row tracking
                        window.newRowIndex = undefined;
                        window.newRowData = {};
                    }
                }

                // Process deletions
                for (const rowIndex of window.deletedRows) {
                    const rowData = window.sqlTableData.data[rowIndex];
                    const id = rowData.Id || rowData.id || rowData.ID;
                    
                    if (id) {
                        const deleteQuery = `DELETE FROM ${tableName} WHERE Id = ${id}`;
                        await apiCall('/api/Admin/execute-sql', {
                            method: 'POST',
                            body: JSON.stringify({ query: deleteQuery })
                        });
                        queriesExecuted++;
                    }
                }

                // Process updates
                const updates = new Map(); // Group by row
                for (const [cellKey, newValue] of window.modifiedCells) {
                    const [rowIndex, key] = cellKey.split('-');
                    if (!updates.has(rowIndex)) {
                        updates.set(rowIndex, {});
                    }
                    updates.get(rowIndex)[key] = newValue;
                }

                for (const [rowIndex, changes] of updates) {
                    const rowData = window.sqlTableData.data[rowIndex];
                    const id = rowData.Id || rowData.id || rowData.ID;
                    
                    if (id) {
                        const setClauses = Object.entries(changes).map(([key, value]) => {
                            // Handle NULL values
                            if (value === 'NULL' || value === null) {
                                return `${key} = NULL`;
                            }
                            // Handle numbers
                            if (!isNaN(value) && value !== '') {
                                return `${key} = ${value}`;
                            }
                            // Handle strings (escape single quotes)
                            const escapedValue = String(value).replace(/'/g, "''");
                            return `${key} = '${escapedValue}'`;
                        }).join(', ');

                        const updateQuery = `UPDATE ${tableName} SET ${setClauses} WHERE Id = ${id}`;
                        await apiCall('/api/Admin/execute-sql', {
                            method: 'POST',
                            body: JSON.stringify({ query: updateQuery })
                        });
                        queriesExecuted++;
                    }
                }

                // Show success and refresh
                alert(`SUCCESS: ${queriesExecuted} OPERATIONS COMPLETED`);
                
                // Re-run the query to refresh the table
                const lastQuery = document.getElementById('sqlQuery').value;
                if (lastQuery) {
                    await executeSqlQuery();
                }

            } catch (error) {
                alert('ERROR: ' + error.message);
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // Insert new row
        function insertNewRow(tableName) {
            if (!window.sqlTableData || !window.sqlTableData.keys) {
                alert('ERROR: Cannot determine table structure');
                return;
            }

            // Check if there's already a new row being edited
            if (window.newRowIndex !== undefined) {
                alert('Please save or cancel the current new row first');
                return;
            }

            const keys = window.sqlTableData.keys;
            const tbody = document.querySelector('#sqlResultsTable tbody');
            const columnWidths = window.originalColumnWidths;
            
            // Create new row index (negative to distinguish from existing rows)
            window.newRowIndex = -1;
            window.newRowData = {};
            
            // Create the new row HTML
            let rowHtml = `<tr style="display: flex; background: rgba(82, 208, 117, 0.1);" data-row="-1" id="newRow">`;
            
            // Delete button (shows as cancel for new row)
            rowHtml += `<td style="padding: 8px 5px; border-bottom: 1px solid; border-right: 2px solid; flex: 0 0 60px; text-align: center;">
                <button class="delete-row-btn" onclick="cancelNewRow()" style="background: #d05252; color: #18140c; border: none; padding: 4px 8px; font-size: 9px; letter-spacing: 1px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;">CANCEL</button>
            </td>`;
            
            // Add cells for each column
            keys.forEach((key, index) => {
                const width = columnWidths[index];
                const isId = key.toLowerCase() === 'id';
                
                if (isId) {
                    rowHtml += `<td data-col="${index}" class="sql-cell" style="padding: 8px 5px; border-bottom: 1px solid; border-right: 2px solid; opacity: 0.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 0 0 ${width}px; font-size: 10px; font-style: italic;">AUTO</td>`;
                } else {
                    rowHtml += `<td data-col="${index}" data-key="${key}" class="sql-cell editable-cell" contenteditable="true" style="padding: 8px 5px; border-bottom: 1px solid; border-right: 2px solid; opacity: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 0 0 ${width}px; font-size: 10px; cursor: text; background: rgba(82, 208, 117, 0.05);" oninput="trackNewRowChange('${key}', this.textContent)" placeholder="NULL"></td>`;
                }
            });
            
            rowHtml += '</tr>';
            
            // Insert at the top of tbody
            tbody.insertAdjacentHTML('afterbegin', rowHtml);
            
            // Show save button
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
            
            // Focus on first editable cell
            const firstEditableCell = document.querySelector('#newRow .editable-cell');
            if (firstEditableCell) {
                firstEditableCell.focus();
            }
        }

        function trackNewRowChange(key, value) {
            window.newRowData[key] = value.trim();
        }

        function cancelNewRow() {
            const newRow = document.getElementById('newRow');
            if (newRow) {
                newRow.remove();
            }
            window.newRowIndex = undefined;
            window.newRowData = {};
            
            // Hide save button if no other changes
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn && window.deletedRows.size === 0 && window.modifiedCells.size === 0) {
                saveBtn.style.display = 'none';
            }
        }

        function toggleColumn(colIndex) {
            window.expandedColumns = window.expandedColumns || new Set();
            
            const isExpanding = !window.expandedColumns.has(colIndex);
            
            if (isExpanding) {
                window.expandedColumns.add(colIndex);
            } else {
                window.expandedColumns.delete(colIndex);
            }
            
            // Get the header element
            const header = document.querySelector(`th[data-col="${colIndex}"]`);
            if (!header) return;
            
            // Get original width from stored values
            const originalWidth = window.originalColumnWidths[colIndex];
            
            if (isExpanding) {
                const maxWidth = window.columnMaxWidths[colIndex] || 400;
                header.style.flex = `0 0 ${maxWidth}px`;
                header.classList.add('expanded');
                header.style.background = document.body.classList.contains('dark-mode') ? '#aba9a2' : '#18140c';
                header.style.color = document.body.classList.contains('dark-mode') ? '#18140c' : '#aba9a2';
            } else {
                header.style.flex = `0 0 ${originalWidth}px`;
                header.classList.remove('expanded');
                header.style.background = 'transparent';
                header.style.color = '';
            }
            
            // Update all cells in this column
            const cells = document.querySelectorAll(`td.sql-cell[data-col="${colIndex}"]`);
            cells.forEach(cell => {
                if (isExpanding) {
                    const maxWidth = window.columnMaxWidths[colIndex] || 400;
                    cell.style.flex = `0 0 ${maxWidth}px`;
                    cell.style.whiteSpace = 'normal';
                    cell.style.overflow = 'visible';
                    cell.style.textOverflow = 'clip';
                    cell.style.opacity = '1';
                } else {
                    cell.style.flex = `0 0 ${originalWidth}px`;
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.overflow = 'hidden';
                    cell.style.textOverflow = 'ellipsis';
                    cell.style.opacity = '1';
                }
            });
        }

        async function loadAuditLogs() {
            try {
                const logs = await apiCall('/api/Admin/audit-logs');
                
                console.log('Audit logs response:', logs);
                
                if (!logs || logs.length === 0) {
                    document.getElementById('auditContent').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px;">NO AUDIT LOGS FOUND</div>';
                    return;
                }

                const logsHtml = logs.map(log => `
                    <div class="kill-entry">
                        <div class="kill-players">
                            <span class="player-name">${log.action}</span>
                            <span class="meta-item">BY: ${log.adminUsername}</span>
                        </div>
                        <div class="kill-meta">
                            <span class="meta-item">${log.details || ''}</span>
                            <span class="kill-time">${new Date(log.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('auditContent').innerHTML = logsHtml;
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                document.getElementById('auditContent').innerHTML = `<div class="error" style="text-align: center; padding: 40px;">FAILED TO LOAD AUDIT LOGS<br><small style="font-size: 9px; opacity: 0.7;">${error.message || 'Unknown error'}</small></div>`;
            }
        }

        async function reassignKills() {
            const sourceUserId = document.getElementById('sourceUserId').value;
            const targetUserId = document.getElementById('targetUserId').value;
            const messageBox = document.getElementById('toolsMessage');

            if (!sourceUserId || !targetUserId) {
                messageBox.textContent = 'ERROR: BOTH USER IDS ARE REQUIRED';
                messageBox.style.color = '#d05252';
                return;
            }

            try {
                // Only validate that the target user exists (source user may have been deleted)
                const checkQuery = `SELECT Username FROM Users WHERE Id = ${parseInt(targetUserId)}`;
                const checkResult = await apiCall('/api/Admin/execute-sql', {
                    method: 'POST',
                    body: JSON.stringify({ query: checkQuery })
                });

                if (checkResult.data.length === 0) {
                    messageBox.textContent = 'ERROR: TARGET USER ID NOT FOUND';
                    messageBox.style.color = '#d05252';
                    return;
                }

                // Execute the reassignment
                const reassignQuery = `UPDATE Kills SET UserId = ${parseInt(targetUserId)} WHERE UserId = ${parseInt(sourceUserId)}`;
                const result = await apiCall('/api/Admin/execute-sql', {
                    method: 'POST',
                    body: JSON.stringify({ query: reassignQuery })
                });

                const killsReassigned = result.rowsAffected || 0;

                if (killsReassigned === 0) {
                    messageBox.textContent = `WARNING: NO KILLS FOUND FOR USER ${sourceUserId}`;
                    messageBox.style.color = '#d05252';
                } else {
                    messageBox.textContent = `SUCCESS: ${killsReassigned} KILLS REASSIGNED FROM USER ${sourceUserId} TO USER ${targetUserId}`;
                    messageBox.style.color = '#d05252';
                }

                document.getElementById('sourceUserId').value = '';
                document.getElementById('targetUserId').value = '';
                
                await loadUsers();
                await loadStats();

                setTimeout(() => {
                    messageBox.textContent = 'KILL REASSIGNMENT';
                    messageBox.style.color = '';
                }, 3000);
            } catch (error) {
                messageBox.textContent = 'ERROR: ' + error.message.toUpperCase();
                messageBox.style.color = '#d05252';
            }
        }

        async function clearUserDatabase() {
            if (confirm('WARNING: This will permanently delete ALL users from the database. This action cannot be undone. Are you absolutely sure?')) {
                if (confirm('FINAL CONFIRMATION: Delete all users?')) {
                    try {
                        await apiCall('/api/Admin/users/clear', { method: 'DELETE' });
                        alert('User database cleared successfully');
                        await loadUsers();
                        await loadStats();
                    } catch (error) {
                        alert('Failed to clear user database: ' + error.message);
                    }
                }
            }
        }

        async function clearKillsDatabase() {
            if (confirm('WARNING: This will permanently delete ALL kills from the database. This action cannot be undone. Are you absolutely sure?')) {
                if (confirm('FINAL CONFIRMATION: Delete all kills?')) {
                    try {
                        await apiCall('/api/Admin/kills/clear', { method: 'DELETE' });
                        alert('Kills database cleared successfully');
                        await loadUsers();
                        await loadStats();
                    } catch (error) {
                        alert('Failed to clear kills database: ' + error.message);
                    }
                }
            }
        }

        function logout() {
            if (confirm('Logout from admin panel?')) {
                localStorage.removeItem('adminToken');
                window.location.href = 'admin-login.html';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.removeItem('darkMode');
            }
        }

        // Initialize
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }

        // Set admin username in header
        const adminUsername = localStorage.getItem('adminUsername');
        if (adminUsername) {
            document.getElementById('adminUsername').textContent = adminUsername.toUpperCase();
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // Load initial data
        loadStats();
        loadUsers();
    </script>
</body>
</html>
