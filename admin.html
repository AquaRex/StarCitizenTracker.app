<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL - STAR TRACKER</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-logo">
                <span class="logo-text">ADMIN PANEL</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="logo-text" id="adminUsername" style="font-size: 11px;">ADMIN</span>
                <button class="btn btn-icon" id="darkModeToggle" title="Toggle Dark Mode">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="btn btn-icon" onclick="logout()" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
            <div class="main-stats" style="border-bottom: none;">
                <div class="stat-box" id="totalUsers">
                    <div class="stat-label">TOTAL USERS</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="verifiedUsers">
                    <div class="stat-label">VERIFIED</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="totalKills">
                    <div class="stat-label">TOTAL KILLS</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="stat-box" id="adminLogins">
                    <div class="stat-label">ADMIN LOGINS</div>
                    <div class="stat-value">-</div>
                </div>
            </div>
        </div>

        <!-- View Buttons -->
        <div class="view-buttons">
            <button class="view-btn active" onclick="switchTab('users', event)">USERS</button>
            <button class="view-btn" onclick="switchTab('audit', event)">AUDIT LOGS</button>
            <button class="view-btn" onclick="switchTab('tools', event)">TOOLS</button>
        </div>

        <!-- Users Tab -->
        <div id="usersTab">
            <!-- Search and Filter Panel -->
            <div class="filter-panel">
                <div class="filter-row">
                    <div class="search-container">
                        <input type="text" id="userSearch" class="search-input" placeholder="SEARCH USERNAME OR IN-GAME NAME..." oninput="filterUsers()">
                    </div>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="custom-select" id="verificationFilter">
                        <div class="select-display">ALL USERS</div>
                        <div class="select-options">
                            <div class="select-option" data-value="all">ALL USERS</div>
                            <div class="select-option" data-value="verified">VERIFIED ONLY</div>
                            <div class="select-option" data-value="unverified">UNVERIFIED ONLY</div>
                        </div>
                    </div>
                    <div class="custom-select" id="sortFilter">
                        <div class="select-display">SORT OPTIONS</div>
                        <div class="select-options">
                            <div class="select-option" data-value="newest">NEWEST FIRST</div>
                            <div class="select-option" data-value="oldest">OLDEST FIRST</div>
                            <div class="select-option" data-value="kills-high">MOST KILLS</div>
                            <div class="select-option" data-value="kills-low">LEAST KILLS</div>
                            <div class="select-option" data-value="username">USERNAME A-Z</div>
                        </div>
                    </div>
                    <button class="reset-filter-btn" onclick="resetFilters()" style="width: 100%;">RESET FILTERS</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area" id="usersContent">
                <div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">LOADING USERS...</div>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="auditTab" style="display: none;">
            <div class="content-area" id="auditContent" style="min-height: 400px;">
                <div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">LOADING AUDIT LOGS...</div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div id="toolsTab" style="display: none;">
            <div class="filter-panel">
                <div class="filter-row">
                    <div id="toolsMessage" style="padding: 25px 40px; font-size: 11px; letter-spacing: 2px; text-transform: uppercase;">KILL REASSIGNMENT</div>
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
                    <input type="text" id="sourceUserId" class="search-input" placeholder="SOURCE USER ID" style="border-right: 2px solid #18140c;">
                    <input type="text" id="targetUserId" class="search-input" placeholder="TARGET USER ID">
                </div>
                <div class="filter-row" style="grid-template-columns: 1fr;">
                    <button class="view-btn" onclick="reassignKills()" style="width: 100%;">REASSIGN KILLS</button>
                </div>
            </div>
            
            <div class="content-area" style="min-height: 200px; display: grid; grid-template-columns: 1fr 1fr;">
                <button class="view-btn" onclick="clearUserDatabase()" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;">CLEAR USER DATABASE</button>
                <button class="view-btn" onclick="clearKillsDatabase()" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border: none;">CLEAR KILLS DATABASE</button>
            </div>
        </div>
    </div>

    <script src="config/api.js"></script>
    <script>
        let allUsers = [];
        let filteredUsers = [];
        let expandedUserId = null;
        let redirecting = false;

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('adminToken');
            
            if (!token) {
                if (!redirecting) {
                    redirecting = true;
                    localStorage.removeItem('adminToken');
                    window.location.replace('admin-login.html');
                }
                return null;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });

                if (response.status === 401) {
                    if (!redirecting) {
                        redirecting = true;
                        localStorage.removeItem('adminToken');
                        window.location.replace('admin-login.html');
                    }
                    return null;
                }

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'API request failed');
                }

                return response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const stats = await apiCall('/api/Admin/stats');
                if (stats) {
                    document.querySelector('#totalUsers .stat-value').textContent = stats.totalUsers || 0;
                    document.querySelector('#verifiedUsers .stat-value').textContent = stats.verifiedUsers || 0;
                    document.querySelector('#totalKills .stat-value').textContent = stats.totalKills || 0;
                    document.querySelector('#adminLogins .stat-value').textContent = stats.adminLogins || 0;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const result = await apiCall('/api/Admin/users');
                if (result) {
                    allUsers = result;
                    filteredUsers = [...allUsers];
                    renderUsers();
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersContent').innerHTML = '<div class="error" style="text-align: center; padding: 40px;">FAILED TO LOAD USERS</div>';
            }
        }

        function renderUsers() {
            if (filteredUsers.length === 0) {
                document.getElementById('usersContent').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; font-size: 12px; letter-spacing: 2px; text-transform: uppercase;">NO USERS FOUND</div>';
                return;
            }

            const usersHtml = filteredUsers.map(user => `
                <div class="user-item" id="user-${user.id}" style="border-bottom: 2px solid #18140c;">
                    <div class="kill-entry" onclick="toggleUserDetails(${user.id})" style="cursor: pointer; border-bottom: none;">
                        <div class="kill-players">
                            <span class="player-name" style="font-weight: 500;">${user.username || 'Unknown'}</span>
                            <span class="meta-item" style="margin-left: 20px;">ID: ${user.id}</span>
                            ${user.isPublicProfile ? '<span class="meta-item" style="color: #52d075;">✓ VERIFIED</span>' : '<span class="meta-item" style="color: #d05252;">✗ NOT VERIFIED</span>'}
                        </div>
                        <div class="kill-meta">
                            <span class="meta-item">${user.totalKills || 0} KILLS</span>
                            <span class="meta-item">${user.inGameName || 'NO IN-GAME NAME'}</span>
                            <span class="kill-time">${new Date(user.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="user-details" id="details-${user.id}" style="display: none; border: 2px solid #18140c; margin: 40px;">
                        <div style="padding: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">USER ID</div>
                                <div style="font-size: 14px;">${user.id}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">USERNAME</div>
                                <div style="font-size: 14px;">${user.username || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">IN-GAME NAME</div>
                                <div style="font-size: 14px;">${user.inGameName || 'NO IN-GAME NAME'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">EMAIL</div>
                                <div style="font-size: 14px;">${user.email || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">VERIFIED</div>
                                <div style="font-size: 14px;">${user.isPublicProfile ? 'YES' : 'NO'}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">TOTAL KILLS</div>
                                <div style="font-size: 14px;">${user.totalKills || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">CREATED</div>
                                <div style="font-size: 14px;">${new Date(user.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; opacity: 0.7;">LAST LOGIN</div>
                                <div style="font-size: 14px;">${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString() : 'Never'}</div>
                            </div>
                        </div>
                        <div style="padding: 40px; padding-top: 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; border: 2px solid #18140c;">
                                <button class="view-btn" style="background: #d05252; border-color: #d05252; color: #aba9a2; border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;" onclick="deleteUser(${user.id})">DELETE USER</button>
                                <button class="view-btn" style="border-radius: 0; border-right: 2px solid #18140c; border-top: none; border-bottom: none; border-left: none;" onclick="resetPassword(${user.id})">RESET PASSWORD</button>
                                <button class="view-btn" style="border-radius: 0; border: none;" onclick="toggleVerification(${user.id})">${user.isPublicProfile ? 'UNVERIFY' : 'VERIFY'} USER</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('usersContent').innerHTML = usersHtml;
        }

        function toggleUserDetails(userId) {
            const detailsElement = document.getElementById(`details-${userId}`);
            
            if (expandedUserId === userId) {
                detailsElement.style.display = 'none';
                expandedUserId = null;
            } else {
                if (expandedUserId !== null) {
                    const previousDetails = document.getElementById(`details-${expandedUserId}`);
                    if (previousDetails) {
                        previousDetails.style.display = 'none';
                    }
                }
                detailsElement.style.display = 'block';
                expandedUserId = userId;
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    await apiCall(`/api/Admin/users/${userId}`, { method: 'DELETE' });
                    alert('User deleted successfully');
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    alert('Failed to delete user: ' + error.message);
                }
            }
        }

        async function resetPassword(userId) {
            if (confirm('Send password reset email to this user?')) {
                try {
                    await apiCall(`/api/Admin/users/${userId}/reset-password`, { method: 'POST' });
                    alert('Password reset email sent successfully');
                } catch (error) {
                    alert('Failed to send password reset: ' + error.message);
                }
            }
        }

        async function toggleVerification(userId) {
            const user = allUsers.find(u => u.id === userId);
            const action = user.isPublicProfile ? 'unverify' : 'verify';
            
            if (confirm(`${action.toUpperCase()} this user?`)) {
                try {
                    await apiCall(`/api/Admin/users/${userId}/verification`, {
                        method: 'PUT',
                        body: JSON.stringify({ isPublicProfile: !user.isPublicProfile })
                    });
                    alert(`User ${action}ed successfully`);
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    alert(`Failed to ${action} user: ` + error.message);
                }
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const verificationFilterValue = document.querySelector('#verificationFilter .select-display').getAttribute('data-value') || 'all';
            const sortFilter = document.querySelector('#sortFilter .select-display').getAttribute('data-value') || 'newest';

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = searchTerm === '' || 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) || 
                    (user.inGameName && user.inGameName.toLowerCase().includes(searchTerm));
                
                const matchesVerification = 
                    verificationFilterValue === 'all' ||
                    (verificationFilterValue === 'verified' && user.isPublicProfile) ||
                    (verificationFilterValue === 'unverified' && !user.isPublicProfile);

                return matchesSearch && matchesVerification;
            });

            // Sort users
            switch(sortFilter) {
                case 'oldest':
                    filteredUsers.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'kills-high':
                    filteredUsers.sort((a, b) => (b.totalKills || 0) - (a.totalKills || 0));
                    break;
                case 'kills-low':
                    filteredUsers.sort((a, b) => (a.totalKills || 0) - (b.totalKills || 0));
                    break;
                case 'username':
                    filteredUsers.sort((a, b) => (a.username || '').localeCompare(b.username || ''));
                    break;
                case 'newest':
                default:
                    filteredUsers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
            }

            renderUsers();
        }

        // Custom select dropdown functionality
        document.addEventListener('click', (e) => {
            const select = e.target.closest('.custom-select');
            if (select) {
                e.stopPropagation();
                document.querySelectorAll('.custom-select').forEach(s => {
                    if (s !== select) s.classList.remove('open');
                });
                select.classList.toggle('open');
            } else {
                document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
            }
        });

        document.querySelectorAll('.custom-select').forEach(select => {
            const display = select.querySelector('.select-display');
            const options = select.querySelectorAll('.select-option');
            
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    display.textContent = option.textContent;
                    display.setAttribute('data-value', option.getAttribute('data-value'));
                    select.classList.remove('open');
                    filterUsers();
                });
            });
        });

        function resetFilters() {
            document.getElementById('userSearch').value = '';
            document.querySelector('#verificationFilter .select-display').textContent = 'ALL USERS';
            document.querySelector('#verificationFilter .select-display').setAttribute('data-value', 'all');
            document.querySelector('#sortFilter .select-display').textContent = 'SORT OPTIONS';
            document.querySelector('#sortFilter .select-display').removeAttribute('data-value');
            filterUsers();
        }

        function switchTab(tabName, event) {
            document.getElementById('usersTab').style.display = 'none';
            document.getElementById('auditTab').style.display = 'none';
            document.getElementById('toolsTab').style.display = 'none';

            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`${tabName}Tab`).style.display = 'block';
            event.target.classList.add('active');

            if (tabName === 'audit' && document.getElementById('auditContent').innerHTML.includes('LOADING')) {
                loadAuditLogs();
            }
        }

        async function loadAuditLogs() {
            try {
                const logs = await apiCall('/api/Admin/audit-logs');
                if (!logs || logs.length === 0) {
                    document.getElementById('auditContent').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px;">NO AUDIT LOGS FOUND</div>';
                    return;
                }

                const logsHtml = logs.map(log => `
                    <div class="kill-entry">
                        <div class="kill-players">
                            <span class="player-name">${log.action}</span>
                            <span class="meta-item">BY: ${log.adminUsername}</span>
                        </div>
                        <div class="kill-meta">
                            <span class="meta-item">${log.details || ''}</span>
                            <span class="kill-time">${new Date(log.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('auditContent').innerHTML = logsHtml;
            } catch (error) {
                document.getElementById('auditContent').innerHTML = '<div class="error" style="text-align: center; padding: 40px;">FAILED TO LOAD AUDIT LOGS</div>';
            }
        }

        async function reassignKills() {
            const sourceUserId = document.getElementById('sourceUserId').value;
            const targetUserId = document.getElementById('targetUserId').value;
            const messageBox = document.getElementById('toolsMessage');

            if (!sourceUserId || !targetUserId) {
                messageBox.textContent = 'ERROR: BOTH USER IDS ARE REQUIRED';
                messageBox.style.color = '#d05252';
                return;
            }

            try {
                const result = await apiCall('/api/Admin/reassign-kills', {
                    method: 'POST',
                    body: JSON.stringify({
                        sourceUserId: parseInt(sourceUserId),
                        targetUserId: parseInt(targetUserId)
                    })
                });

                messageBox.textContent = `SUCCESS: ${result.killsReassigned} KILLS REASSIGNED FROM USER ${sourceUserId} TO USER ${targetUserId}`;
                messageBox.style.color = '#52d075';

                document.getElementById('sourceUserId').value = '';
                document.getElementById('targetUserId').value = '';
                
                await loadUsers();
                await loadStats();

                setTimeout(() => {
                    messageBox.textContent = 'KILL REASSIGNMENT';
                    messageBox.style.color = '';
                }, 3000);
            } catch (error) {
                messageBox.textContent = 'ERROR: ' + error.message.toUpperCase();
                messageBox.style.color = '#d05252';
            }
        }

        async function clearUserDatabase() {
            if (confirm('WARNING: This will permanently delete ALL users from the database. This action cannot be undone. Are you absolutely sure?')) {
                if (confirm('FINAL CONFIRMATION: Delete all users?')) {
                    try {
                        await apiCall('/api/Admin/users/clear', { method: 'DELETE' });
                        alert('User database cleared successfully');
                        await loadUsers();
                        await loadStats();
                    } catch (error) {
                        alert('Failed to clear user database: ' + error.message);
                    }
                }
            }
        }

        async function clearKillsDatabase() {
            if (confirm('WARNING: This will permanently delete ALL kills from the database. This action cannot be undone. Are you absolutely sure?')) {
                if (confirm('FINAL CONFIRMATION: Delete all kills?')) {
                    try {
                        await apiCall('/api/Admin/kills/clear', { method: 'DELETE' });
                        alert('Kills database cleared successfully');
                        await loadUsers();
                        await loadStats();
                    } catch (error) {
                        alert('Failed to clear kills database: ' + error.message);
                    }
                }
            }
        }

        function logout() {
            if (confirm('Logout from admin panel?')) {
                localStorage.removeItem('adminToken');
                window.location.href = 'admin-login.html';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.removeItem('darkMode');
            }
        }

        // Initialize
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // Load initial data
        loadStats();
        loadUsers();
    </script>
</body>
</html>
